# IM系统 Docker Compose 部署配置
# version: '3.8'  # 已废弃，移除以避免警告

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: im_db
      MYSQL_USER: im_user
      MYSQL_PASSWORD: im_password
    ports:
      - "13306:3306" # 使用 13306 避免与本地 MySQL 冲突
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - im-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "16379:6379" # 使用 16379 避免与本地 Redis 冲突
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - im-network

  # MongoDB消息存储
  mongodb:
    image: mongo:7.0
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: im_db
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - im-network

  # MinIO对象存储
  minio:
    image: minio/minio:latest
    restart: always
    ports:
      - "9000:9000" # API端口
      - "9001:9001" # 控制台端口
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - im-network

  # IM Gateway 服务
  im-gateway:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    restart: always
    ports:
      - "8080:8080" # HTTP/WebSocket端口
      - "9090:9090" # Prometheus指标端口
    environment:
      NODE_ID: node1
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306 # 容器内部端口，不变
      MYSQL_USER: im_user
      MYSQL_PASSWORD: im_password
      MYSQL_DATABASE: im_db
      REDIS_HOST: redis
      REDIS_PORT: 6379 # 容器内部端口，不变
      REDIS_PASSWORD: ""
      MONGO_URI: mongodb://root:password123@mongodb:27017
      MONGO_DATABASE: im_db
      JWT_SECRET: your-jwt-secret-key-change-in-production
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_BUCKET: im-files
      MINIO_USE_SSL: "false"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - im-network

  # IM Gateway 节点2（可选，用于多节点部署）
  im-gateway-2:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    restart: always
    ports:
      - "8081:8080"
      - "9091:9090"
    environment:
      NODE_ID: node2
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: im_user
      MYSQL_PASSWORD: im_password
      MYSQL_DATABASE: im_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      MONGO_URI: mongodb://root:password123@mongodb:27017
      MONGO_DATABASE: im_db
      JWT_SECRET: your-jwt-secret-key-change-in-production
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin123
      MINIO_BUCKET: im-files
      MINIO_USE_SSL: "false"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    profiles:
      - multi-node
    networks:
      - im-network

  # Push推送服务
  im-push:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.push
    restart: always
    ports:
      - "8082:8081"
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: im_user
      MYSQL_PASSWORD: im_password
      MYSQL_DATABASE: im_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      # APNs配置（iOS推送）
      APNS_PRODUCTION: "false"
      APNS_BUNDLE_ID: "com.example.im"
      # APNS_KEY_FILE: "/app/config/AuthKey.p8"
      # APNS_KEY_ID: "YOUR_KEY_ID"
      # APNS_TEAM_ID: "YOUR_TEAM_ID"
      # FCM配置（Android推送）
      # FCM_CREDENTIALS_FILE: "/app/config/firebase-credentials.json"
      # FCM_PROJECT_ID: "YOUR_PROJECT_ID"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - push
    networks:
      - im-network

  # Nginx负载均衡（可选）
  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - im-gateway
    profiles:
      - production
    networks:
      - im-network

  # Prometheus监控（可选）
  prometheus:
    image: prom/prometheus:latest
    restart: always
    ports:
      - "9092:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    profiles:
      - monitoring
    networks:
      - im-network

  # Grafana可视化（可选）
  grafana:
    image: grafana/grafana:latest
    restart: always
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    profiles:
      - monitoring
    networks:
      - im-network

# 数据卷
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  mongodb_data:
    driver: local
  minio_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# 网络
networks:
  im-network:
    driver: bridge
