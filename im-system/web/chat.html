<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>IMç³»ç»Ÿ - èŠå¤©Demo</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: "#007bff",
                            "primary-dark": "#0056b3",
                        },
                    },
                },
            };
        </script>
        <style>
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: #f1f1f1;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 3px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #aaa;
            }
        </style>
    </head>
    <body class="bg-gray-100 h-screen flex flex-col font-sans">
        <!-- ç™»å½•ç•Œé¢ -->
        <div
            class="flex justify-center items-center h-screen"
            id="loginContainer"
        >
            <div class="bg-white p-10 rounded-xl shadow-lg w-full max-w-md">
                <h1 class="text-2xl font-bold text-center mb-8">
                    ğŸš€ IMç³»ç»ŸDemo
                </h1>

                <!-- ç™»å½•è¡¨å• -->
                <div id="loginForm">
                    <div class="mb-5">
                        <label class="block text-gray-600 text-sm mb-2"
                            >ç”¨æˆ·å</label
                        >
                        <input
                            type="text"
                            id="username"
                            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <div class="mb-5">
                        <label class="block text-gray-600 text-sm mb-2"
                            >å¯†ç </label
                        >
                        <input
                            type="password"
                            id="password"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <button
                        onclick="login()"
                        class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-lg font-medium transition"
                    >
                        ç™»å½•
                    </button>
                    <button
                        onclick="showRegister()"
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium mt-3 transition"
                    >
                        æ³¨å†Œè´¦å·
                    </button>
                </div>

                <!-- æ³¨å†Œè¡¨å• -->
                <div id="registerForm" class="hidden">
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm mb-2"
                            >ç”¨æˆ·å</label
                        >
                        <input
                            type="text"
                            id="regUsername"
                            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm mb-2"
                            >æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label
                        >
                        <input
                            type="text"
                            id="regNickname"
                            placeholder="è¯·è¾“å…¥æ˜µç§°"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 text-sm mb-2"
                            >å¯†ç </label
                        >
                        <input
                            type="password"
                            id="regPassword"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <div class="mb-5">
                        <label class="block text-gray-600 text-sm mb-2"
                            >ç¡®è®¤å¯†ç </label
                        >
                        <input
                            type="password"
                            id="regPasswordConfirm"
                            placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary transition"
                        />
                    </div>
                    <button
                        onclick="register()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition"
                    >
                        æ³¨å†Œ
                    </button>
                    <button
                        onclick="showLogin()"
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-medium mt-3 transition"
                    >
                        è¿”å›ç™»å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©ç•Œé¢ -->
        <div
            class="hidden flex-1 max-w-7xl mx-auto p-4 w-full"
            id="chatContainer"
        >
            <div
                class="bg-white rounded-xl shadow-lg flex flex-col h-full overflow-hidden"
            >
                <!-- é¡¶éƒ¨æ  -->
                <div
                    class="bg-primary text-white px-5 py-4 flex justify-between items-center"
                >
                    <h2 class="text-lg font-semibold">ğŸ’¬ èŠå¤©</h2>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 text-sm">
                            <span
                                id="statusDot"
                                class="w-2 h-2 rounded-full bg-green-400"
                            ></span>
                            <span id="statusText">å·²è¿æ¥</span>
                        </div>
                        <span id="currentUser" class="font-medium"></span>
                        <button
                            onclick="logout()"
                            class="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded text-sm transition"
                        >
                            é€€å‡º
                        </button>
                    </div>
                </div>

                <!-- ä¸»ä½“ -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- å·¦ä¾§è¾¹æ  -->
                    <div
                        class="w-72 border-r border-gray-200 flex flex-col bg-gray-50"
                    >
                        <!-- Tab åˆ‡æ¢ -->
                        <div class="flex border-b border-gray-200">
                            <button
                                id="tabContacts"
                                onclick="switchTab('contacts')"
                                class="flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary"
                            >
                                ğŸ‘¤ è”ç³»äºº
                            </button>
                            <button
                                id="tabGroups"
                                onclick="switchTab('groups')"
                                class="flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent"
                            >
                                ğŸ‘¥ ç¾¤ç»„
                            </button>
                        </div>

                        <!-- è”ç³»äººé¢æ¿ -->
                        <div
                            id="contactsPanel"
                            class="flex-1 flex flex-col overflow-hidden"
                        >
                            <div class="p-3 border-b border-gray-200">
                                <input
                                    type="text"
                                    id="targetUserInput"
                                    placeholder="è¾“å…¥ç”¨æˆ·IDå¼€å§‹èŠå¤©"
                                    onkeydown="handleUserInputKeydown(event)"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:border-primary"
                                />
                            </div>
                            <div
                                id="contactList"
                                class="flex-1 overflow-y-auto scrollbar-thin"
                            >
                                <div
                                    class="flex flex-col items-center justify-center h-full text-gray-400 text-sm"
                                >
                                    <p>æš‚æ— è”ç³»äºº</p>
                                </div>
                            </div>
                        </div>

                        <!-- ç¾¤ç»„é¢æ¿ -->
                        <div
                            id="groupsPanel"
                            class="hidden flex-1 flex flex-col overflow-hidden"
                        >
                            <div class="p-3 border-b border-gray-200">
                                <button
                                    onclick="showCreateGroupModal()"
                                    class="w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition"
                                >
                                    â• åˆ›å»ºç¾¤ç»„
                                </button>
                            </div>
                            <div class="p-3 border-b border-gray-200">
                                <input
                                    type="text"
                                    id="joinGroupInput"
                                    placeholder="è¾“å…¥ç¾¤IDåŠ å…¥ç¾¤ç»„"
                                    onkeydown="handleJoinGroupKeydown(event)"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-full text-sm focus:outline-none focus:border-primary"
                                />
                            </div>
                            <div
                                id="groupList"
                                class="flex-1 overflow-y-auto scrollbar-thin"
                            >
                                <div
                                    class="flex flex-col items-center justify-center h-full text-gray-400 text-sm"
                                >
                                    <p>æš‚æ— ç¾¤ç»„</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="flex-1 flex flex-col bg-white">
                        <!-- èŠå¤©å¤´éƒ¨ -->
                        <div
                            id="chatWith"
                            class="px-5 py-4 border-b border-gray-200 flex justify-between items-center"
                        >
                            <span class="font-medium text-gray-700"
                                >é€‰æ‹©è”ç³»äººæˆ–ç¾¤ç»„å¼€å§‹èŠå¤©</span
                            >
                            <div id="headerActions" class="hidden">
                                <button
                                    onclick="toggleRightPanel()"
                                    class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm transition"
                                >
                                    â„¹ï¸ è¯¦æƒ…
                                </button>
                            </div>
                        </div>

                        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                        <div
                            id="messageList"
                            class="flex-1 overflow-y-auto p-5 space-y-4 scrollbar-thin"
                        >
                            <div
                                id="emptyState"
                                class="flex flex-col items-center justify-center h-full text-gray-400"
                            >
                                <svg
                                    class="w-20 h-20 mb-4 opacity-50"
                                    viewBox="0 0 24 24"
                                    fill="currentColor"
                                >
                                    <path
                                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"
                                    />
                                </svg>
                                <p>é€‰æ‹©è”ç³»äººæˆ–ç¾¤ç»„å¼€å§‹èŠå¤©</p>
                            </div>
                        </div>

                        <!-- è¾“å…¥åŒºåŸŸ -->
                        <div
                            id="inputArea"
                            class="hidden px-5 py-4 border-t border-gray-200"
                        >
                            <div class="flex gap-3 items-end">
                                <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
                                <input
                                    type="file"
                                    id="fileInput"
                                    class="hidden"
                                    accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
                                    onchange="handleFileSelect(event)"
                                />
                                <button
                                    onclick="document.getElementById('fileInput').click()"
                                    class="w-11 h-11 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full flex items-center justify-center transition flex-shrink-0"
                                    title="å‘é€æ–‡ä»¶"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                    >
                                        <path
                                            d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"
                                        />
                                    </svg>
                                </button>
                                <textarea
                                    id="messageInput"
                                    rows="1"
                                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                                    onkeydown="handleKeyDown(event)"
                                    class="flex-1 px-4 py-3 border border-gray-300 rounded-2xl resize-none focus:outline-none focus:border-primary text-sm max-h-32"
                                ></textarea>
                                <button
                                    onclick="pendingFile ? uploadAndSendFile() : sendMessage()"
                                    class="w-11 h-11 bg-primary hover:bg-primary-dark text-white rounded-full flex items-center justify-center transition flex-shrink-0"
                                >
                                    <svg
                                        class="w-5 h-5"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                    >
                                        <path
                                            d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"
                                        />
                                    </svg>
                                </button>
                            </div>
                            <!-- æ–‡ä»¶é¢„è§ˆåŒº -->
                            <div
                                id="filePreview"
                                class="hidden mt-3 p-3 bg-gray-50 rounded-lg"
                            >
                                <div class="flex items-center gap-3">
                                    <div
                                        id="filePreviewIcon"
                                        class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center overflow-hidden"
                                    >
                                        <img
                                            id="filePreviewImg"
                                            class="hidden w-full h-full object-cover"
                                        />
                                        <span
                                            id="filePreviewExt"
                                            class="text-xs font-bold text-gray-500"
                                        ></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p
                                            id="filePreviewName"
                                            class="text-sm font-medium truncate"
                                        ></p>
                                        <p
                                            id="filePreviewSize"
                                            class="text-xs text-gray-500"
                                        ></p>
                                    </div>
                                    <button
                                        onclick="cancelFileUpload()"
                                        class="text-gray-400 hover:text-red-500"
                                    >
                                        <svg
                                            class="w-5 h-5"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            stroke="currentColor"
                                            stroke-width="2"
                                        >
                                            <path d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div id="uploadProgress" class="hidden mt-2">
                                    <div
                                        class="w-full bg-gray-200 rounded-full h-1.5"
                                    >
                                        <div
                                            id="uploadProgressBar"
                                            class="bg-primary h-1.5 rounded-full transition-all"
                                            style="width: 0%"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§è¯¦æƒ…é¢æ¿ -->
                    <div
                        id="rightPanel"
                        class="hidden w-72 border-l border-gray-200 flex flex-col bg-gray-50"
                    >
                        <div
                            class="px-4 py-4 border-b border-gray-200 flex justify-between items-center"
                        >
                            <span id="panelTitle" class="font-medium"
                                >è¯¦æƒ…</span
                            >
                            <button
                                onclick="toggleRightPanel()"
                                class="text-gray-400 hover:text-gray-600 text-xl"
                            >
                                &times;
                            </button>
                        </div>
                        <div
                            id="panelContent"
                            class="flex-1 overflow-y-auto p-4 scrollbar-thin"
                        >
                            <!-- åŠ¨æ€å†…å®¹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºç¾¤ç»„æ¨¡æ€æ¡† -->
        <div
            id="createGroupModal"
            class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
        >
            <div
                class="bg-white rounded-xl p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto"
            >
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-lg font-semibold">åˆ›å»ºç¾¤ç»„</h3>
                    <button
                        onclick="closeModal('createGroupModal')"
                        class="text-gray-400 hover:text-gray-600 text-2xl"
                    >
                        &times;
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 text-sm mb-2"
                            >ç¾¤åç§°</label
                        >
                        <input
                            type="text"
                            id="newGroupName"
                            placeholder="è¯·è¾“å…¥ç¾¤åç§°"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-primary text-sm"
                        />
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-2"
                            >ç¾¤æè¿°ï¼ˆå¯é€‰ï¼‰</label
                        >
                        <input
                            type="text"
                            id="newGroupDesc"
                            placeholder="è¯·è¾“å…¥ç¾¤æè¿°"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-primary text-sm"
                        />
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-2"
                            >é€‰æ‹©æˆå‘˜ï¼ˆå¯é€‰ï¼‰</label
                        >
                        <div
                            id="memberCheckboxList"
                            class="border border-gray-200 rounded-lg p-3 max-h-48 overflow-y-auto"
                        >
                            <p class="text-gray-400 text-sm">æš‚æ— è”ç³»äººå¯é€‰</p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button
                        onclick="closeModal('createGroupModal')"
                        class="flex-1 py-2.5 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition"
                    >
                        å–æ¶ˆ
                    </button>
                    <button
                        onclick="createGroup()"
                        class="flex-1 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition"
                    >
                        åˆ›å»º
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast æç¤º -->
        <div
            id="toast"
            class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg text-sm opacity-0 transition-all duration-300 translate-y-4 pointer-events-none z-50"
        ></div>

        <script>
            // ==================== é…ç½® ====================
            const API_BASE = window.location.origin;
            const WS_BASE =
                window.location.protocol === "https:" ? "wss://" : "ws://";
            const WS_URL = WS_BASE + window.location.host + "/ws";

            // ==================== çŠ¶æ€ ====================
            let token = localStorage.getItem("token");
            let currentUser = JSON.parse(
                localStorage.getItem("currentUser") || "null",
            );
            let ws = null;
            let reconnectTimer = null;
            let reconnectAttempts = 0;
            let heartbeatTimer = null;

            let currentChat = null; // { type: 'user' | 'group', id: string }
            let messages = {};
            let contacts = [];
            let groups = [];
            let groupMembers = {};

            // ==================== åˆå§‹åŒ– ====================
            document.addEventListener("DOMContentLoaded", () => {
                if (token && currentUser) {
                    showChat();
                    connectWebSocket();
                    loadUserGroups();
                }

                // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                const textarea = document.getElementById("messageInput");
                textarea.addEventListener("input", () => {
                    textarea.style.height = "auto";
                    textarea.style.height =
                        Math.min(textarea.scrollHeight, 128) + "px";
                });
            });

            // ==================== è®¤è¯ ====================
            function showLogin() {
                document.getElementById("loginForm").classList.remove("hidden");
                document.getElementById("registerForm").classList.add("hidden");
            }

            function showRegister() {
                document.getElementById("loginForm").classList.add("hidden");
                document
                    .getElementById("registerForm")
                    .classList.remove("hidden");
            }

            async function login() {
                const username = document
                    .getElementById("username")
                    .value.trim();
                const password = document.getElementById("password").value;

                if (!username || !password) {
                    showToast("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (response.ok && data.code === 0) {
                        token = data.data.token;
                        currentUser = {
                            user_id: data.data.user_id,
                            username: data.data.username,
                            nickname: data.data.nickname,
                        };

                        localStorage.setItem("token", token);
                        localStorage.setItem(
                            "currentUser",
                            JSON.stringify(currentUser),
                        );

                        showChat();
                        connectWebSocket();
                        loadUserGroups();
                        showToast("ç™»å½•æˆåŠŸ");
                    } else {
                        showToast(data.error || "ç™»å½•å¤±è´¥");
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    showToast("ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•");
                }
            }

            async function register() {
                const username = document
                    .getElementById("regUsername")
                    .value.trim();
                const nickname = document
                    .getElementById("regNickname")
                    .value.trim();
                const password = document.getElementById("regPassword").value;
                const passwordConfirm =
                    document.getElementById("regPasswordConfirm").value;

                if (!username || !password) {
                    showToast("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
                    return;
                }

                if (password !== passwordConfirm) {
                    showToast("ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´");
                    return;
                }

                if (password.length < 6) {
                    showToast("å¯†ç é•¿åº¦è‡³å°‘6ä½");
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/register`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ username, nickname, password }),
                    });

                    const data = await response.json();

                    if (response.ok && data.code === 0) {
                        showToast("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                        showLogin();
                        document.getElementById("username").value = username;
                    } else {
                        showToast(data.error || "æ³¨å†Œå¤±è´¥");
                    }
                } catch (error) {
                    console.error("Register error:", error);
                    showToast("ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•");
                }
            }

            function logout() {
                if (ws) ws.close();
                token = null;
                currentUser = null;
                currentChat = null;
                messages = {};
                contacts = [];
                groups = [];

                localStorage.removeItem("token");
                localStorage.removeItem("currentUser");

                document
                    .getElementById("loginContainer")
                    .classList.remove("hidden");
                document.getElementById("loginContainer").classList.add("flex");
                document
                    .getElementById("chatContainer")
                    .classList.add("hidden");
                document
                    .getElementById("chatContainer")
                    .classList.remove("flex");

                showToast("å·²é€€å‡ºç™»å½•");
            }

            function showChat() {
                document
                    .getElementById("loginContainer")
                    .classList.add("hidden");
                document
                    .getElementById("loginContainer")
                    .classList.remove("flex");
                document
                    .getElementById("chatContainer")
                    .classList.remove("hidden");
                document.getElementById("chatContainer").classList.add("flex");
                document.getElementById("currentUser").textContent =
                    currentUser.nickname || currentUser.username;
            }

            // ==================== WebSocket ====================
            function connectWebSocket() {
                if (ws && ws.readyState === WebSocket.OPEN) return;

                updateConnectionStatus("connecting");
                ws = new WebSocket(`${WS_URL}?token=${token}`);

                ws.onopen = () => {
                    console.log("WebSocket connected");
                    updateConnectionStatus("connected");
                    reconnectAttempts = 0;
                    startHeartbeat();
                };

                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                };

                ws.onclose = (event) => {
                    console.log(
                        "WebSocket disconnected",
                        event.code,
                        event.reason,
                    );
                    updateConnectionStatus("disconnected");
                    stopHeartbeat();
                    scheduleReconnect();
                };

                ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };
            }

            function updateConnectionStatus(status) {
                const dot = document.getElementById("statusDot");
                const text = document.getElementById("statusText");

                dot.className = "w-2 h-2 rounded-full";
                switch (status) {
                    case "connected":
                        dot.classList.add("bg-green-400");
                        text.textContent = "å·²è¿æ¥";
                        break;
                    case "connecting":
                        dot.classList.add("bg-yellow-400", "animate-pulse");
                        text.textContent = "è¿æ¥ä¸­...";
                        break;
                    case "disconnected":
                        dot.classList.add("bg-red-400");
                        text.textContent = "å·²æ–­å¼€";
                        break;
                }
            }

            function scheduleReconnect() {
                if (reconnectTimer) return;
                reconnectAttempts++;
                const delay = Math.min(
                    1000 * Math.pow(2, reconnectAttempts),
                    30000,
                );
                console.log(
                    `Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`,
                );

                reconnectTimer = setTimeout(() => {
                    reconnectTimer = null;
                    if (token) connectWebSocket();
                }, delay);
            }

            function startHeartbeat() {
                stopHeartbeat();
                heartbeatTimer = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(
                            JSON.stringify({
                                type: 99,
                                content: { timestamp: Date.now() },
                            }),
                        );
                    }
                }, 30000);
            }

            function stopHeartbeat() {
                if (heartbeatTimer) {
                    clearInterval(heartbeatTimer);
                    heartbeatTimer = null;
                }
            }

            // ==================== æ¶ˆæ¯å¤„ç† ====================
            function handleMessage(msg) {
                console.log("Received message:", msg);

                switch (msg.type) {
                    case 0:
                    case 1:
                        handlePrivateMessage(msg);
                        break;
                    case 2:
                        handleGroupMessage(msg);
                        break;
                    case 4: // å›¾ç‰‡æ¶ˆæ¯
                    case 5: // è¯­éŸ³æ¶ˆæ¯
                    case 6: // è§†é¢‘æ¶ˆæ¯
                    case 7: // æ–‡ä»¶æ¶ˆæ¯
                        if (msg.group_id) {
                            handleGroupMessage(msg);
                        } else {
                            handlePrivateMessage(msg);
                        }
                        break;
                    case 20:
                    case 30:
                        console.log("Message ACK:", msg);
                        break;
                    case 100:
                        showToast(
                            msg.content?.reason || "æ‚¨çš„è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•",
                        );
                        logout();
                        break;
                }
            }

            function handlePrivateMessage(msg) {
                const fromUser = msg.from;
                const isFromMe = fromUser === currentUser.user_id;
                const chatId = isFromMe ? msg.to : fromUser;
                const chatKey = `user:${chatId}`;

                addContact(chatId);

                if (!messages[chatKey]) messages[chatKey] = [];

                // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
                const contentType = getContentType(msg.type, msg.content);
                const content =
                    contentType === "text"
                        ? typeof msg.content === "string"
                            ? msg.content
                            : msg.content?.text || JSON.stringify(msg.content)
                        : msg.content;

                const messageData = {
                    id: msg.message_id,
                    from: fromUser,
                    content: content,
                    contentType: contentType,
                    timestamp: msg.timestamp,
                    isFromMe,
                };

                messages[chatKey].push(messageData);

                if (currentChat?.type === "user" && currentChat.id === chatId) {
                    appendMessage(messageData);
                } else if (!isFromMe) {
                    updateUnreadCount("user", chatId);
                    showToast(`æ”¶åˆ°æ¥è‡ª ${chatId} çš„æ–°æ¶ˆæ¯`);
                }
            }

            // è·å–æ¶ˆæ¯å†…å®¹ç±»å‹
            function getContentType(msgType, content) {
                if (
                    msgType === 4 ||
                    (typeof content === "object" &&
                        content.file_type === "image")
                ) {
                    return "image";
                }
                if (
                    msgType === 7 ||
                    (typeof content === "object" &&
                        content.file_id &&
                        content.file_type !== "image")
                ) {
                    return "file";
                }
                if (msgType === 5) return "voice";
                if (msgType === 6) return "video";
                return "text";
            }

            function handleGroupMessage(msg) {
                const groupId = msg.group_id || msg.to;
                const fromUser = msg.from;
                const isFromMe = fromUser === currentUser.user_id;
                const chatKey = `group:${groupId}`;

                if (!messages[chatKey]) messages[chatKey] = [];

                // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
                const contentType = getContentType(msg.type, msg.content);
                const content =
                    contentType === "text"
                        ? typeof msg.content === "string"
                            ? msg.content
                            : msg.content?.text || JSON.stringify(msg.content)
                        : msg.content;

                const messageData = {
                    id: msg.message_id,
                    from: fromUser,
                    content: content,
                    contentType: contentType,
                    timestamp: msg.timestamp,
                    isFromMe,
                };

                messages[chatKey].push(messageData);

                if (
                    currentChat?.type === "group" &&
                    currentChat.id === groupId
                ) {
                    appendMessage(messageData);
                } else if (!isFromMe) {
                    updateUnreadCount("group", groupId);
                    const group = groups.find(
                        (g) => (g.group_id || g.id) === groupId,
                    );
                    showToast(`${group?.name || groupId} æœ‰æ–°æ¶ˆæ¯`);
                }
            }

            // ==================== å‘é€æ¶ˆæ¯ ====================
            function sendMessage() {
                const input = document.getElementById("messageInput");
                const content = input.value.trim();

                if (!content || !currentChat) return;

                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showToast("è¿æ¥å·²æ–­å¼€ï¼Œè¯·ç¨å€™é‡è¯•");
                    return;
                }

                const msg =
                    currentChat.type === "user"
                        ? {
                              type: 1,
                              to: currentChat.id,
                              content: { text: content },
                              timestamp: Date.now(),
                          }
                        : {
                              type: 2,
                              to: currentChat.id,
                              group_id: currentChat.id,
                              content: { text: content },
                              timestamp: Date.now(),
                          };

                ws.send(JSON.stringify(msg));

                const chatKey = `${currentChat.type}:${currentChat.id}`;
                const messageData = {
                    id: Date.now().toString(),
                    from: currentUser.user_id,
                    content,
                    timestamp: Date.now(),
                    isFromMe: true,
                };

                if (!messages[chatKey]) messages[chatKey] = [];
                messages[chatKey].push(messageData);
                appendMessage(messageData);

                input.value = "";
                input.style.height = "auto";
            }

            function handleKeyDown(event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }

            // ==================== æ–‡ä»¶ä¸Šä¼  ====================
            let pendingFile = null;

            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                // æ£€æŸ¥æ–‡ä»¶å¤§å° (æœ€å¤§ 100MB)
                if (file.size > 100 * 1024 * 1024) {
                    showToast("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 100MB");
                    event.target.value = "";
                    return;
                }

                pendingFile = file;
                showFilePreview(file);
            }

            function showFilePreview(file) {
                const preview = document.getElementById("filePreview");
                const previewImg = document.getElementById("filePreviewImg");
                const previewExt = document.getElementById("filePreviewExt");
                const previewName = document.getElementById("filePreviewName");
                const previewSize = document.getElementById("filePreviewSize");

                // æ˜¾ç¤ºé¢„è§ˆåŒº
                preview.classList.remove("hidden");

                // è®¾ç½®æ–‡ä»¶åå’Œå¤§å°
                previewName.textContent = file.name;
                previewSize.textContent = formatFileSize(file.size);

                // åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡
                if (file.type.startsWith("image/")) {
                    previewImg.classList.remove("hidden");
                    previewExt.classList.add("hidden");
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImg.classList.add("hidden");
                    previewExt.classList.remove("hidden");
                    const ext = file.name.split(".").pop().toUpperCase();
                    previewExt.textContent = ext.substring(0, 4);
                }
            }

            function cancelFileUpload() {
                pendingFile = null;
                document.getElementById("fileInput").value = "";
                document.getElementById("filePreview").classList.add("hidden");
                document
                    .getElementById("uploadProgress")
                    .classList.add("hidden");
            }

            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + " B";
                if (bytes < 1024 * 1024)
                    return (bytes / 1024).toFixed(1) + " KB";
                if (bytes < 1024 * 1024 * 1024)
                    return (bytes / (1024 * 1024)).toFixed(1) + " MB";
                return (bytes / (1024 * 1024 * 1024)).toFixed(1) + " GB";
            }

            async function uploadAndSendFile() {
                if (!pendingFile || !currentChat) return;

                const progressBar =
                    document.getElementById("uploadProgressBar");
                document
                    .getElementById("uploadProgress")
                    .classList.remove("hidden");

                try {
                    const formData = new FormData();
                    formData.append("file", pendingFile);

                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", `${API_BASE}/api/file/upload`);
                    xhr.setRequestHeader("Authorization", `Bearer ${token}`);

                    // è¿›åº¦ç›‘å¬
                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round(
                                (e.loaded / e.total) * 100,
                            );
                            progressBar.style.width = percent + "%";
                        }
                    };

                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const resp = JSON.parse(xhr.responseText);
                            if (resp.code === 0 && resp.data) {
                                sendFileMessage(resp.data);
                                cancelFileUpload();
                            } else {
                                showToast(
                                    "ä¸Šä¼ å¤±è´¥: " + (resp.message || "æœªçŸ¥é”™è¯¯"),
                                );
                            }
                        } else {
                            showToast("ä¸Šä¼ å¤±è´¥");
                        }
                    };

                    xhr.onerror = () => {
                        showToast("ä¸Šä¼ å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯");
                    };

                    xhr.send(formData);
                } catch (error) {
                    console.error("Upload error:", error);
                    showToast("ä¸Šä¼ å¤±è´¥: " + error.message);
                }
            }

            function sendFileMessage(fileInfo) {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    showToast("è¿æ¥å·²æ–­å¼€ï¼Œè¯·ç¨å€™é‡è¯•");
                    return;
                }

                const isImage = fileInfo.file_type === "image";
                const msgType = isImage ? 4 : 7; // 4=å›¾ç‰‡, 7=æ–‡ä»¶

                const content = {
                    file_id: fileInfo.file_id,
                    file_name: fileInfo.file_name,
                    file_size: fileInfo.file_size,
                    file_type: fileInfo.file_type,
                    mime_type: fileInfo.mime_type,
                    url: fileInfo.url,
                    thumbnail_url: fileInfo.thumbnail_url || "",
                };

                const msg =
                    currentChat.type === "user"
                        ? {
                              type: msgType,
                              to: currentChat.id,
                              content: content,
                              timestamp: Date.now(),
                          }
                        : {
                              type: msgType,
                              to: currentChat.id,
                              group_id: currentChat.id,
                              content: content,
                              timestamp: Date.now(),
                          };

                ws.send(JSON.stringify(msg));

                // æœ¬åœ°æ˜¾ç¤º
                const chatKey = `${currentChat.type}:${currentChat.id}`;
                const messageData = {
                    id: Date.now().toString(),
                    from: currentUser.user_id,
                    content: content,
                    contentType: isImage ? "image" : "file",
                    timestamp: Date.now(),
                    isFromMe: true,
                };

                if (!messages[chatKey]) messages[chatKey] = [];
                messages[chatKey].push(messageData);
                appendMessage(messageData);
            }

            // ==================== Tab åˆ‡æ¢ ====================
            function switchTab(tab) {
                const tabContacts = document.getElementById("tabContacts");
                const tabGroups = document.getElementById("tabGroups");
                const contactsPanel = document.getElementById("contactsPanel");
                const groupsPanel = document.getElementById("groupsPanel");

                if (tab === "contacts") {
                    tabContacts.className =
                        "flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary";
                    tabGroups.className =
                        "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent";
                    contactsPanel.classList.remove("hidden");
                    contactsPanel.classList.add("flex");
                    groupsPanel.classList.add("hidden");
                    groupsPanel.classList.remove("flex");
                } else {
                    tabGroups.className =
                        "flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary";
                    tabContacts.className =
                        "flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent";
                    groupsPanel.classList.remove("hidden");
                    groupsPanel.classList.add("flex");
                    contactsPanel.classList.add("hidden");
                    contactsPanel.classList.remove("flex");
                }
            }

            // ==================== è”ç³»äºº ====================
            function handleUserInputKeydown(event) {
                if (event.key === "Enter") {
                    const userId = event.target.value.trim();
                    if (userId) {
                        startUserChat(userId);
                        event.target.value = "";
                    }
                }
            }

            function startUserChat(userId) {
                if (userId === currentUser.user_id) {
                    showToast("ä¸èƒ½å’Œè‡ªå·±èŠå¤©");
                    return;
                }

                currentChat = { type: "user", id: userId };
                addContact(userId);

                document.getElementById("chatWith").innerHTML =
                    `<span class="font-medium text-gray-700">ä¸ ${escapeHtml(userId)} èŠå¤©ä¸­</span>`;
                document
                    .getElementById("headerActions")
                    .classList.add("hidden");
                document.getElementById("inputArea").classList.remove("hidden");
                document.getElementById("emptyState")?.remove();
                document.getElementById("rightPanel").classList.add("hidden");

                clearUnreadCount("user", userId);
                highlightItem("user", userId);
                loadPrivateHistory(userId);
            }

            async function loadPrivateHistory(userId) {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/messages/private/${userId}?limit=50`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0 && data.data?.messages) {
                        const chatKey = `user:${userId}`;
                        // å°†å†å²æ¶ˆæ¯è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼å¹¶æŒ‰æ—¶é—´æ­£åºæ’åˆ—
                        const historyMessages = data.data.messages
                            .map((m) => ({
                                id: m.message_id,
                                from: m.from,
                                content:
                                    m.content?.text ||
                                    (typeof m.content === "string"
                                        ? m.content
                                        : JSON.stringify(m.content)),
                                timestamp: m.timestamp,
                                isFromMe: m.from === currentUser.user_id,
                            }))
                            .reverse();

                        messages[chatKey] = historyMessages;
                        renderMessages(chatKey);
                    }
                } catch (error) {
                    console.error("Load private history error:", error);
                    renderMessages(`user:${userId}`);
                }
            }

            function addContact(userId) {
                if (contacts.includes(userId)) return;
                contacts.push(userId);
                renderContacts();
            }

            function renderContacts() {
                const list = document.getElementById("contactList");

                if (contacts.length === 0) {
                    list.innerHTML =
                        '<div class="flex flex-col items-center justify-center h-full text-gray-400 text-sm"><p>æš‚æ— è”ç³»äºº</p></div>';
                    return;
                }

                list.innerHTML = contacts
                    .map((userId) => {
                        const chatKey = `user:${userId}`;
                        const lastMsg = messages[chatKey]?.slice(-1)[0];
                        const preview = lastMsg
                            ? lastMsg.content.substring(0, 20) +
                              (lastMsg.content.length > 20 ? "..." : "")
                            : "æš‚æ— æ¶ˆæ¯";
                        const isActive =
                            currentChat?.type === "user" &&
                            currentChat.id === userId;

                        return `
                    <div onclick="startUserChat('${userId}')" data-type="user" data-id="${userId}"
                        class="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-100 border-b border-gray-100 transition ${isActive ? "bg-blue-50" : ""}">
                        <div class="w-11 h-11 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                            ${userId.substring(0, 2).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 truncate">${escapeHtml(userId)}</div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(preview)}</div>
                        </div>
                    </div>
                `;
                    })
                    .join("");
            }

            // ==================== ç¾¤ç»„ ====================
            async function loadUserGroups() {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/user/groups`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0 && data.data) {
                        groups = data.data.groups || [];
                        renderGroups();
                    }
                } catch (error) {
                    console.error("Load groups error:", error);
                }
            }

            function renderGroups() {
                const list = document.getElementById("groupList");

                if (groups.length === 0) {
                    list.innerHTML =
                        '<div class="flex flex-col items-center justify-center h-full text-gray-400 text-sm"><p>æš‚æ— ç¾¤ç»„</p></div>';
                    return;
                }

                list.innerHTML = groups
                    .map((group) => {
                        const groupId = group.group_id || group.id;
                        const chatKey = `group:${groupId}`;
                        const lastMsg = messages[chatKey]?.slice(-1)[0];
                        const preview = lastMsg
                            ? lastMsg.content.substring(0, 20) +
                              (lastMsg.content.length > 20 ? "..." : "")
                            : "æš‚æ— æ¶ˆæ¯";
                        const isActive =
                            currentChat?.type === "group" &&
                            currentChat.id === groupId;

                        return `
                    <div onclick="startGroupChat('${groupId}')" data-type="group" data-id="${groupId}"
                        class="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-100 border-b border-gray-100 transition ${isActive ? "bg-blue-50" : ""}">
                        <div class="w-11 h-11 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                            ${(group.name || "ç¾¤").substring(0, 2)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800 truncate">${escapeHtml(group.name)}</span>
                                <span onclick="event.stopPropagation(); copyGroupId('${groupId}')" class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded hover:bg-gray-200 cursor-pointer" title="ç‚¹å‡»å¤åˆ¶ç¾¤ID">#${groupId.substring(0, 8)}</span>
                            </div>
                            <div class="text-xs text-gray-500 truncate">${escapeHtml(preview)}</div>
                        </div>
                        <span class="text-xs text-gray-400">${group.member_count || 0}äºº</span>
                    </div>
                `;
                    })
                    .join("");
            }

            function startGroupChat(groupId) {
                console.log("startGroupChat called with:", groupId);
                currentChat = { type: "group", id: groupId };
                const group = groups.find(
                    (g) => (g.group_id || g.id) === groupId,
                );
                console.log("Found group:", group);

                const chatWithEl = document.getElementById("chatWith");
                const headerActionsEl =
                    document.getElementById("headerActions");
                const inputAreaEl = document.getElementById("inputArea");
                const emptyStateEl = document.getElementById("emptyState");

                console.log("Elements found:", {
                    chatWithEl,
                    headerActionsEl,
                    inputAreaEl,
                    emptyStateEl,
                });

                if (chatWithEl) {
                    chatWithEl.innerHTML = `<span class="font-medium text-gray-700">ğŸ  ${escapeHtml(group?.name || groupId)}</span>`;
                }
                if (headerActionsEl) {
                    headerActionsEl.classList.remove("hidden");
                }
                if (inputAreaEl) {
                    inputAreaEl.classList.remove("hidden");
                    console.log(
                        "inputArea hidden class removed, current classes:",
                        inputAreaEl.className,
                    );
                }
                if (emptyStateEl) {
                    emptyStateEl.style.display = "none";
                }

                clearUnreadCount("group", groupId);
                highlightItem("group", groupId);
                loadGroupMembers(groupId);
                loadGroupHistory(groupId);
            }

            async function loadGroupHistory(groupId) {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/messages/group/${groupId}?limit=50`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0 && data.data?.messages) {
                        const chatKey = `group:${groupId}`;
                        // å°†å†å²æ¶ˆæ¯è½¬æ¢ä¸ºå‰ç«¯æ ¼å¼å¹¶æŒ‰æ—¶é—´æ­£åºæ’åˆ—
                        const historyMessages = data.data.messages
                            .map((m) => ({
                                id: m.message_id,
                                from: m.from,
                                content:
                                    m.content?.text ||
                                    (typeof m.content === "string"
                                        ? m.content
                                        : JSON.stringify(m.content)),
                                timestamp: m.timestamp,
                                isFromMe: m.from === currentUser.user_id,
                            }))
                            .reverse();

                        messages[chatKey] = historyMessages;
                        renderMessages(chatKey);
                    }
                } catch (error) {
                    console.error("Load group history error:", error);
                    renderMessages(`group:${groupId}`);
                }
            }

            async function loadGroupMembers(groupId) {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/groups/${groupId}/members`,
                        {
                            headers: { Authorization: `Bearer ${token}` },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0 && data.data) {
                        groupMembers[groupId] = data.data.members || [];
                    }
                } catch (error) {
                    console.error("Load group members error:", error);
                }
            }

            function handleJoinGroupKeydown(event) {
                if (event.key === "Enter") {
                    const groupId = event.target.value.trim();
                    if (groupId) {
                        joinGroup(groupId);
                        event.target.value = "";
                    }
                }
            }

            async function joinGroup(groupId) {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/groups/${groupId}/join`,
                        {
                            method: "POST",
                            headers: {
                                Authorization: `Bearer ${token}`,
                                "Content-Type": "application/json",
                            },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0) {
                        showToast("åŠ å…¥ç¾¤ç»„æˆåŠŸ");
                        loadUserGroups();
                    } else {
                        showToast(data.error || "åŠ å…¥ç¾¤ç»„å¤±è´¥");
                    }
                } catch (error) {
                    console.error("Join group error:", error);
                    showToast("ç½‘ç»œé”™è¯¯");
                }
            }

            // ==================== åˆ›å»ºç¾¤ç»„ ====================
            function showCreateGroupModal() {
                const checkboxList =
                    document.getElementById("memberCheckboxList");

                if (contacts.length === 0) {
                    checkboxList.innerHTML =
                        '<p class="text-gray-400 text-sm">æš‚æ— è”ç³»äººå¯é€‰</p>';
                } else {
                    checkboxList.innerHTML = contacts
                        .map(
                            (userId) => `
                    <label class="flex items-center gap-3 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="${userId}" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-medium">
                            ${userId.substring(0, 2).toUpperCase()}
                        </div>
                        <span class="text-sm">${escapeHtml(userId)}</span>
                    </label>
                `,
                        )
                        .join("");
                }

                document.getElementById("newGroupName").value = "";
                document.getElementById("newGroupDesc").value = "";
                document
                    .getElementById("createGroupModal")
                    .classList.remove("hidden");
                document
                    .getElementById("createGroupModal")
                    .classList.add("flex");
            }

            async function createGroup() {
                const name = document
                    .getElementById("newGroupName")
                    .value.trim();
                const description = document
                    .getElementById("newGroupDesc")
                    .value.trim();

                if (!name) {
                    showToast("è¯·è¾“å…¥ç¾¤åç§°");
                    return;
                }

                const checkboxes = document.querySelectorAll(
                    '#memberCheckboxList input[type="checkbox"]:checked',
                );
                const memberIds = Array.from(checkboxes).map((cb) => cb.value);

                try {
                    const response = await fetch(`${API_BASE}/api/groups`, {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            name,
                            description,
                            member_ids: memberIds,
                        }),
                    });

                    const data = await response.json();
                    if (data.code === 0) {
                        showToast("åˆ›å»ºç¾¤ç»„æˆåŠŸ");
                        closeModal("createGroupModal");
                        loadUserGroups();
                    } else {
                        showToast(data.error || "åˆ›å»ºç¾¤ç»„å¤±è´¥");
                    }
                } catch (error) {
                    console.error("Create group error:", error);
                    showToast("ç½‘ç»œé”™è¯¯");
                }
            }

            // ==================== å³ä¾§é¢æ¿ ====================
            function toggleRightPanel() {
                const panel = document.getElementById("rightPanel");
                if (panel.classList.contains("hidden")) {
                    panel.classList.remove("hidden");
                    renderPanelContent();
                } else {
                    panel.classList.add("hidden");
                }
            }

            function renderPanelContent() {
                const content = document.getElementById("panelContent");

                if (!currentChat) {
                    content.innerHTML =
                        '<p class="text-gray-400">è¯·å…ˆé€‰æ‹©èŠå¤©</p>';
                    return;
                }

                if (currentChat.type === "user") {
                    document.getElementById("panelTitle").textContent =
                        "è”ç³»äººä¿¡æ¯";
                    content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-xs text-gray-500 uppercase mb-1">ç”¨æˆ·ID</h4>
                            <p class="text-sm text-gray-800">${escapeHtml(currentChat.id)}</p>
                        </div>
                    </div>
                `;
                } else {
                    const group = groups.find(
                        (g) => (g.group_id || g.id) === currentChat.id,
                    );
                    const members = groupMembers[currentChat.id] || [];

                    document.getElementById("panelTitle").textContent =
                        "ç¾¤ç»„ä¿¡æ¯";

                    const membersHtml = members
                        .map((m) => {
                            const roleText =
                                m.role === 1
                                    ? "ç¾¤ä¸»"
                                    : m.role === 2
                                      ? "ç®¡ç†å‘˜"
                                      : "";
                            const roleClass =
                                m.role === 1
                                    ? "text-yellow-500"
                                    : m.role === 2
                                      ? "text-green-500"
                                      : "";

                            return `
                        <div class="flex items-center gap-3 p-2 rounded hover:bg-gray-100">
                            <div class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-medium">
                                ${(m.user_id || "").substring(0, 2).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium">${escapeHtml(m.nickname || m.user_id)}</div>
                                ${roleText ? `<div class="text-xs ${roleClass}">${roleText}</div>` : ""}
                            </div>
                        </div>
                    `;
                        })
                        .join("");

                    content.innerHTML = `
                    <div class="space-y-5">
                        <div>
                            <h4 class="text-xs text-gray-500 uppercase mb-1">ç¾¤åç§°</h4>
                            <p class="text-sm text-gray-800">${escapeHtml(group?.name || currentChat.id)}</p>
                        </div>
                        <div>
                            <h4 class="text-xs text-gray-500 uppercase mb-1">ç¾¤ID</h4>
                            <p class="text-xs text-gray-600 break-all">${currentChat.id}</p>
                        </div>
                        <div>
                            <h4 class="text-xs text-gray-500 uppercase mb-1">ç¾¤æè¿°</h4>
                            <p class="text-sm text-gray-800">${escapeHtml(group?.description || "æš‚æ— æè¿°")}</p>
                        </div>
                        <div>
                            <h4 class="text-xs text-gray-500 uppercase mb-2">ç¾¤æˆå‘˜ (${members.length})</h4>
                            <div class="space-y-1">${membersHtml || '<p class="text-gray-400 text-sm">åŠ è½½ä¸­...</p>'}</div>
                        </div>
                        <div class="space-y-2 pt-4 border-t border-gray-200">
                            <button onclick="leaveGroup()" class="w-full py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition">
                                é€€å‡ºç¾¤ç»„
                            </button>
                        </div>
                    </div>
                `;
                }
            }

            async function leaveGroup() {
                if (!currentChat || currentChat.type !== "group") return;
                if (!confirm("ç¡®å®šè¦é€€å‡ºè¯¥ç¾¤ç»„å—ï¼Ÿ")) return;

                try {
                    const response = await fetch(
                        `${API_BASE}/api/groups/${currentChat.id}/leave`,
                        {
                            method: "POST",
                            headers: { Authorization: `Bearer ${token}` },
                        },
                    );

                    const data = await response.json();
                    if (data.code === 0) {
                        showToast("å·²é€€å‡ºç¾¤ç»„");
                        currentChat = null;
                        document
                            .getElementById("rightPanel")
                            .classList.add("hidden");
                        document.getElementById("chatWith").innerHTML =
                            '<span class="font-medium text-gray-700">é€‰æ‹©è”ç³»äººæˆ–ç¾¤ç»„å¼€å§‹èŠå¤©</span>';
                        document
                            .getElementById("headerActions")
                            .classList.add("hidden");
                        document
                            .getElementById("inputArea")
                            .classList.add("hidden");
                        document.getElementById("messageList").innerHTML = `
                        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                            <svg class="w-20 h-20 mb-4 opacity-50" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                            </svg>
                            <p>é€‰æ‹©è”ç³»äººæˆ–ç¾¤ç»„å¼€å§‹èŠå¤©</p>
                        </div>
                    `;
                        loadUserGroups();
                    } else {
                        showToast(data.error || "é€€å‡ºç¾¤ç»„å¤±è´¥");
                    }
                } catch (error) {
                    console.error("Leave group error:", error);
                    showToast("ç½‘ç»œé”™è¯¯");
                }
            }

            // ==================== æ¶ˆæ¯æ¸²æŸ“ ====================
            function renderMessages(chatKey) {
                const list = document.getElementById("messageList");
                const chatMessages = messages[chatKey] || [];

                if (chatMessages.length === 0) {
                    list.innerHTML =
                        '<div class="text-center text-gray-400 text-sm py-4">å¼€å§‹èŠå¤©å§ï¼</div>';
                    return;
                }

                list.innerHTML = "";
                chatMessages.forEach((msg) => appendMessage(msg, false));
                list.scrollTop = list.scrollHeight;
            }

            function appendMessage(msg, scroll = true) {
                const list = document.getElementById("messageList");

                const emptyState = document.getElementById("emptyState");
                if (emptyState) emptyState.remove();

                const systemMsg = list.querySelector(".text-center");
                if (systemMsg) systemMsg.remove();

                const avatar = msg.isFromMe
                    ? (currentUser.nickname || currentUser.username)
                          .substring(0, 1)
                          .toUpperCase()
                    : (msg.from || "?").substring(0, 2).toUpperCase();

                const time = new Date(msg.timestamp).toLocaleTimeString(
                    "zh-CN",
                    { hour: "2-digit", minute: "2-digit" },
                );

                const senderHtml =
                    !msg.isFromMe && currentChat?.type === "group"
                        ? `<div class="text-xs text-gray-500 mb-1">${escapeHtml(msg.from)}</div>`
                        : "";

                // æ¸²æŸ“æ¶ˆæ¯å†…å®¹
                const contentHtml = renderMessageContent(msg);

                const div = document.createElement("div");
                div.className = `flex gap-3 ${msg.isFromMe ? "flex-row-reverse" : ""}`;
                div.innerHTML = `
                <div class="w-9 h-9 rounded-full ${msg.isFromMe ? "bg-gradient-to-br from-blue-500 to-blue-600" : "bg-gradient-to-br from-indigo-500 to-purple-600"} flex items-center justify-center text-white text-sm font-medium flex-shrink-0">
                    ${avatar}
                </div>
                <div class="max-w-[70%] ${msg.isFromMe ? "items-end" : "items-start"} flex flex-col">
                    ${senderHtml}
                    ${contentHtml}
                    <div class="text-xs text-gray-400 mt-1">${time}</div>
                </div>
            `;

                list.appendChild(div);
                if (scroll) list.scrollTop = list.scrollHeight;
            }

            // æ¸²æŸ“æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ï¼‰
            function renderMessageContent(msg) {
                const content = msg.content;
                const isFromMe = msg.isFromMe;
                const bubbleClass = isFromMe
                    ? "bg-primary text-white"
                    : "bg-gray-100 text-gray-800";

                // åˆ¤æ–­æ¶ˆæ¯ç±»å‹
                if (
                    msg.contentType === "image" ||
                    (typeof content === "object" &&
                        content.file_type === "image")
                ) {
                    // å›¾ç‰‡æ¶ˆæ¯
                    const url = content.url || content.thumbnail_url;
                    return `
                        <div class="rounded-2xl overflow-hidden cursor-pointer" onclick="showImagePreview('${escapeHtml(content.url || url)}')">
                            <img src="${escapeHtml(url)}" alt="å›¾ç‰‡" class="max-w-full max-h-64 rounded-lg" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22><rect fill=%22%23eee%22 width=%22200%22 height=%22150%22/><text x=%22100%22 y=%2275%22 text-anchor=%22middle%22 fill=%22%23999%22>å›¾ç‰‡åŠ è½½å¤±è´¥</text></svg>'"/>
                        </div>
                    `;
                } else if (
                    msg.contentType === "file" ||
                    (typeof content === "object" &&
                        content.file_id &&
                        content.file_type !== "image")
                ) {
                    // æ–‡ä»¶æ¶ˆæ¯
                    const fileName = content.file_name || "æœªçŸ¥æ–‡ä»¶";
                    const fileSize = formatFileSize(content.file_size || 0);
                    const fileExt = fileName.split(".").pop().toUpperCase();
                    const fileUrl = content.url;

                    return `
                        <div class="${bubbleClass} px-4 py-3 rounded-2xl">
                            <a href="${escapeHtml(fileUrl)}" target="_blank" class="flex items-center gap-3 no-underline ${isFromMe ? "text-white" : "text-gray-800"}">
                                <div class="w-10 h-10 rounded-lg ${isFromMe ? "bg-white/20" : "bg-gray-200"} flex items-center justify-center flex-shrink-0">
                                    <span class="text-xs font-bold ${isFromMe ? "text-white" : "text-gray-500"}">${escapeHtml(fileExt.substring(0, 4))}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium truncate">${escapeHtml(fileName)}</div>
                                    <div class="text-xs ${isFromMe ? "text-white/70" : "text-gray-500"}">${fileSize}</div>
                                </div>
                                <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                            </a>
                        </div>
                    `;
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    const text =
                        typeof content === "string"
                            ? content
                            : content.text || JSON.stringify(content);
                    return `
                        <div class="${bubbleClass} px-4 py-2.5 rounded-2xl text-sm break-words">
                            ${escapeHtml(text)}
                        </div>
                    `;
                }
            }

            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            function showImagePreview(url) {
                const overlay = document.createElement("div");
                overlay.className =
                    "fixed inset-0 bg-black/80 flex items-center justify-center z-50 cursor-pointer";
                overlay.onclick = () => overlay.remove();
                overlay.innerHTML = `
                    <img src="${escapeHtml(url)}" class="max-w-[90vw] max-h-[90vh] object-contain" onclick="event.stopPropagation()"/>
                    <button class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300" onclick="this.parentElement.remove()">&times;</button>
                `;
                document.body.appendChild(overlay);
            }

            // ==================== æœªè¯»è®¡æ•° ====================
            function updateUnreadCount(type, id) {
                const item = document.querySelector(
                    `[data-type="${type}"][data-id="${id}"]`,
                );
                if (!item) return;

                let badge = item.querySelector(".unread-badge");
                if (!badge) {
                    badge = document.createElement("span");
                    badge.className =
                        "unread-badge bg-red-500 text-white text-xs px-2 py-0.5 rounded-full ml-auto";
                    badge.textContent = "1";
                    item.appendChild(badge);
                } else {
                    badge.textContent = parseInt(badge.textContent) + 1;
                }
            }

            function clearUnreadCount(type, id) {
                const item = document.querySelector(
                    `[data-type="${type}"][data-id="${id}"]`,
                );
                if (!item) return;
                const badge = item.querySelector(".unread-badge");
                if (badge) badge.remove();
            }

            function highlightItem(type, id) {
                document.querySelectorAll("[data-type]").forEach((item) => {
                    item.classList.remove("bg-blue-50");
                });

                const item = document.querySelector(
                    `[data-type="${type}"][data-id="${id}"]`,
                );
                if (item) item.classList.add("bg-blue-50");
            }

            // ==================== å·¥å…·å‡½æ•° ====================
            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function copyGroupId(groupId) {
                navigator.clipboard
                    .writeText(groupId)
                    .then(() => {
                        showToast("ç¾¤IDå·²å¤åˆ¶: " + groupId);
                    })
                    .catch(() => {
                        // Fallback for older browsers
                        const input = document.createElement("input");
                        input.value = groupId;
                        document.body.appendChild(input);
                        input.select();
                        document.execCommand("copy");
                        document.body.removeChild(input);
                        showToast("ç¾¤IDå·²å¤åˆ¶: " + groupId);
                    });
            }

            function showToast(message) {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.classList.remove("opacity-0", "translate-y-4");
                toast.classList.add("opacity-100", "translate-y-0");

                setTimeout(() => {
                    toast.classList.add("opacity-0", "translate-y-4");
                    toast.classList.remove("opacity-100", "translate-y-0");
                }, 3000);
            }

            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add("hidden");
                modal.classList.remove("flex");
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.querySelectorAll(".fixed.inset-0").forEach((modal) => {
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) {
                        modal.classList.add("hidden");
                        modal.classList.remove("flex");
                    }
                });
            });
        </script>
    </body>
</html>
