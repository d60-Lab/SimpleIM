# IM系统配置文件

# 服务配置
server:
  # Gateway服务配置
  gateway:
    host: "0.0.0.0"
    port: 8080
    node_id: "node1"  # 节点标识，多节点部署时需唯一
    read_timeout: 30s
    write_timeout: 30s
    max_connections: 10000  # 单节点最大连接数

  # Push服务配置
  push:
    host: "0.0.0.0"
    port: 8081
    worker_count: 10  # 推送Worker数量
    batch_size: 100   # 批量推送大小

  # HTTP API配置
  api:
    host: "0.0.0.0"
    port: 8082
    read_timeout: 10s
    write_timeout: 10s

# WebSocket配置
websocket:
  read_buffer_size: 1024
  write_buffer_size: 1024
  max_message_size: 65536  # 64KB
  ping_interval: 30s       # 心跳间隔
  pong_timeout: 60s        # 心跳超时
  handshake_timeout: 10s

# MySQL配置
mysql:
  host: "localhost"
  port: 3306
  username: "root"
  password: "password"
  database: "im_db"
  charset: "utf8mb4"
  max_open_conns: 100
  max_idle_conns: 10
  conn_max_lifetime: 3600s
  log_level: "warn"  # silent, error, warn, info

# Redis配置
redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0
  pool_size: 100
  min_idle_conns: 10
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s

# 消息配置
message:
  # 离线消息配置
  offline:
    max_count: 1000           # 每用户最大离线消息数
    expire_days: 7            # 离线消息过期天数
    cleanup_interval: 1h      # 清理任务间隔

  # 消息去重配置
  dedup:
    cache_size: 10000         # LRU缓存大小
    expire_seconds: 300       # 去重缓存过期时间

  # 消息撤回配置
  revoke:
    max_time: 120s            # 撤回时间限制（2分钟）

  # 消息序列号配置
  sequence:
    step: 1000                # 序列号步长（批量获取）

# 群组配置
group:
  max_members: 500            # 群最大成员数
  max_groups_per_user: 500    # 用户可加入的最大群数
  max_admins: 10              # 最大管理员数

# 推送服务配置
push_service:
  # APNs配置 (iOS)
  apns:
    enabled: true
    production: false         # true=生产环境, false=沙盒环境
    bundle_id: "com.example.im"
    key_file: "/path/to/AuthKey.p8"
    key_id: "YOUR_KEY_ID"
    team_id: "YOUR_TEAM_ID"

  # FCM配置 (Android)
  fcm:
    enabled: true
    server_key: "YOUR_FCM_SERVER_KEY"
    project_id: "YOUR_PROJECT_ID"
    credentials_file: "/path/to/firebase-credentials.json"

  # 推送策略
  strategy:
    merge_interval: 5s        # 合并推送间隔
    max_retries: 3            # 最大重试次数
    retry_interval: 5s        # 重试间隔

# 文件存储配置
storage:
  provider: "minio"           # minio, aliyun, aws, qiniu

  # MinIO配置
  minio:
    endpoint: "localhost:9000"
    access_key: "minioadmin"
    secret_key: "minioadmin123"
    bucket: "im-files"
    use_ssl: false
    region: "cn-north-1"

  # 阿里云OSS配置 (可选)
  aliyun:
    endpoint: "oss-cn-hangzhou.aliyuncs.com"
    access_key: ""
    secret_key: ""
    bucket: "im-files"

  # AWS S3配置 (可选)
  aws:
    region: "us-east-1"
    access_key: ""
    secret_key: ""
    bucket: "im-files"

  # CDN域名
  cdn_domain: ""

  # 文件限制
  limits:
    max_image_size: 10485760      # 10MB
    max_video_size: 104857600     # 100MB
    max_file_size: 52428800       # 50MB
    max_audio_size: 20971520      # 20MB
    chunk_size: 5242880           # 分片大小 5MB

  # 签名URL过期时间
  signed_url_expire: 2h

  # 允许的文件类型
  allowed_types:
    image:
      - "image/jpeg"
      - "image/png"
      - "image/gif"
      - "image/webp"
    video:
      - "video/mp4"
      - "video/quicktime"
      - "video/webm"
    audio:
      - "audio/mpeg"
      - "audio/wav"
      - "audio/ogg"
      - "audio/aac"
    document:
      - "application/pdf"
      - "application/msword"
      - "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      - "application/vnd.ms-excel"
      - "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      - "application/vnd.ms-powerpoint"
      - "application/vnd.openxmlformats-officedocument.presentationml.presentation"
      - "text/plain"
      - "application/zip"
      - "application/x-rar-compressed"

# JWT认证配置
auth:
  jwt:
    secret: "your-jwt-secret-key-change-in-production"
    issuer: "im-system"
    expire: 168h              # 7天
    refresh_expire: 720h      # 30天

# 日志配置
log:
  level: "info"               # debug, info, warn, error
  format: "json"              # json, text
  output: "stdout"            # stdout, file
  file:
    path: "/var/log/im"
    max_size: 100             # MB
    max_backups: 7
    max_age: 30               # days
    compress: true

# 监控配置
metrics:
  enabled: true
  host: "0.0.0.0"
  port: 9090
  path: "/metrics"

# 链路追踪配置
tracing:
  enabled: false
  provider: "jaeger"          # jaeger, zipkin
  endpoint: "http://localhost:14268/api/traces"
  sample_rate: 0.1            # 采样率

# 限流配置
rate_limit:
  enabled: true
  # 全局限流
  global:
    requests_per_second: 10000
    burst: 20000
  # 单用户限流
  per_user:
    requests_per_second: 100
    burst: 200
  # 单IP限流
  per_ip:
    requests_per_second: 500
    burst: 1000

# 安全配置
security:
  # CORS配置
  cors:
    enabled: true
    allow_origins:
      - "*"
    allow_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
    allow_headers:
      - "Origin"
      - "Content-Type"
      - "Accept"
      - "Authorization"
      - "X-Request-ID"
    expose_headers:
      - "X-Request-ID"
    allow_credentials: true
    max_age: 86400

  # 加密配置
  encryption:
    enabled: false
    algorithm: "aes-256-gcm"

  # 内容安全
  content_security:
    virus_scan_enabled: false
    sensitive_word_filter: true
    sensitive_words_file: "/path/to/sensitive_words.txt"

# 开发环境配置
development:
  debug: true
  pprof_enabled: true
  pprof_port: 6060
